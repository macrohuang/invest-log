# 故障排除与常见问题

<cite>
**本文档引用的文件**
- [app.py](file://app.py)
- [config.py](file://config.py)
- [database.py](file://database.py)
- [price_fetcher.py](file://price_fetcher.py)
- [logger_config.py](file://logger_config.py)
- [requirements.txt](file://requirements.txt)
- [routers/api.py](file://routers/api.py)
- [routers/holdings.py](file://routers/holdings.py)
- [routers/transactions.py](file://routers/transactions.py)
- [routers/overview.py](file://routers/overview.py)
- [routers/utils.py](file://routers/utils.py)
- [templates/base.html](file://templates/base.html)
- [templates/index.html](file://templates/index.html)
</cite>

## 目录
1. [简介](#简介)
2. [启动问题排查](#启动问题排查)
3. [价格获取失败排查](#价格获取失败排查)
4. [数据库问题诊断](#数据库问题诊断)
5. [Web界面访问异常排查](#web界面访问异常排查)
6. [性能问题诊断](#性能问题诊断)
7. [错误日志分析](#错误日志分析)
8. [调试工具使用](#调试工具使用)
9. [问题分类与优先级处理](#问题分类与优先级处理)
10. [预防性维护建议](#预防性维护建议)

## 简介

投资日志管理系统是一个基于FastAPI的Web应用程序，用于跟踪和管理股票、债券、贵金属等各类资产的投资交易记录。该系统采用SQLite作为本地数据库存储，支持多货币和多账户管理，并提供实时价格获取功能。

本指南旨在帮助用户快速识别和解决系统运行过程中遇到的各种问题，涵盖从启动故障到性能优化的完整故障排除流程。

## 启动问题排查

### 端口占用问题

**症状表现：**
- 应用程序启动时显示端口被占用错误
- Uvicorn运行器无法绑定到指定端口

**排查步骤：**
1. 检查默认端口配置
   - 默认监听地址：127.0.0.1
   - 默认端口：8000

2. 查找占用端口的进程
   ```bash
   lsof -i :8000
   # 或者在Windows上使用
   netstat -ano | findstr :8000
   ```

3. 修改端口配置
   - 通过环境变量设置新端口：`INVEST_LOG_PORT=8080`
   - 或修改应用配置中的端口号

**解决方案：**
- 更换端口号或释放被占用的端口
- 检查防火墙设置是否允许端口通信
- 验证Python虚拟环境是否正确激活

**章节来源**
- [app.py](file://app.py#L31-L34)

### 依赖缺失问题

**症状表现：**
- 导入模块时出现ImportError
- 运行时提示缺少特定库

**排查步骤：**
1. 检查依赖安装状态
   ```bash
   pip install -r requirements.txt
   ```

2. 验证核心依赖
   - fastapi>=0.100.0
   - uvicorn[standard]>=0.23.0
   - jinja2>=3.1.0
   - python-multipart>=0.0.6
   - akshare>=1.10.0

3. 特定库检查
   - 检查AKShare库是否正确安装
   - 验证yfinance库（可选）可用性

**解决方案：**
- 完整重新安装依赖包
- 使用虚拟环境隔离依赖
- 检查Python版本兼容性

**章节来源**
- [requirements.txt](file://requirements.txt#L1-L6)

### 数据库初始化失败

**症状表现：**
- 应用启动时报数据库连接错误
- 表结构创建失败

**排查步骤：**
1. 检查数据库路径配置
   - iCloud同步路径：`~/Library/Mobile Documents/com~apple~CloudDocs/InvestLog/`
   - 默认数据库文件：`transactions.db`

2. 验证目录权限
   ```bash
   ls -la ~/Library/Mobile\ Documents/com~apple~CloudDocs/InvestLog/
   ```

3. 检查数据库文件状态
   - 确认文件存在且可读写
   - 验证SQLite文件完整性

**解决方案：**
- 手动创建InvestLog目录
- 调整文件权限设置
- 清理损坏的数据库文件

**章节来源**
- [config.py](file://config.py#L10-L24)
- [database.py](file://database.py#L22-L189)

## 价格获取失败排查

### 网络连接问题

**症状表现：**
- 价格获取超时或连接失败
- API请求返回网络错误

**排查步骤：**
1. 测试网络连通性
   ```bash
   ping sina.com.cn
   ping qt.gtimg.cn
   ```

2. 检查代理设置
   - 验证系统代理配置
   - 测试直连网络访问

3. 验证DNS解析
   ```bash
   nslookup hq.sinajs.cn
   nslookup qt.gtimg.cn
   ```

**解决方案：**
- 配置系统代理或关闭代理
- 使用备用网络环境
- 检查防火墙规则

### API限流问题

**症状表现：**
- 请求被拒绝或返回429状态码
- 数据源响应超时

**排查步骤：**
1. 检查请求频率
   - 分析价格更新频率
   - 避免频繁重复请求

2. 实施退避策略
   - 增加请求间隔时间
   - 实现指数退避算法

3. 监控API使用情况
   - 记录请求次数
   - 设置使用上限

**解决方案：**
- 调整价格更新频率
- 实现缓存机制
- 使用更稳定的API源

### 数据源切换策略

**当前数据源优先级：**
1. AKShare（主要）
2. Yahoo Finance（备份1）
3. Sina Finance API（备份2）
4. Tencent Finance API（备份3）

**排查步骤：**
1. 检查各数据源可用性
   - 测试AKShare功能
   - 验证Yahoo Finance连接
   - 测试国内API接口

2. 实现降级策略
   - 自动检测数据源状态
   - 实现故障转移机制

**解决方案：**
- 优先使用AKShare作为主数据源
- 配置合理的超时时间
- 实现数据源健康检查

**章节来源**
- [price_fetcher.py](file://price_fetcher.py#L7-L12)
- [price_fetcher.py](file://price_fetcher.py#L325-L402)

## 数据库问题诊断

### 锁表问题

**症状表现：**
- 数据库操作超时
- 查询执行缓慢
- 事务长时间阻塞

**排查步骤：**
1. 检查数据库锁状态
   ```sql
   PRAGMA locking_mode;
   PRAGMA journal_mode;
   ```

2. 监控并发访问
   - 检查同时连接数
   - 分析长事务持有情况

3. 识别死锁场景
   - 分析查询执行计划
   - 检查索引使用情况

**解决方案：**
- 优化事务处理逻辑
- 实现连接池管理
- 调整数据库参数

### 数据库文件损坏

**症状表现：**
- SQLite错误：database disk image is malformed
- 查询执行失败
- 数据库无法打开

**排查步骤：**
1. 验证数据库完整性
   ```sql
   PRAGMA integrity_check;
   ```

2. 检查磁盘空间
   - 确保有足够的存储空间
   - 验证文件系统状态

3. 备份现有数据
   ```bash
   sqlite3 transactions.db ".backup backup.db"
   ```

**解决方案：**
- 使用VACUUM重建数据库
- 从备份恢复数据
- 考虑重新初始化数据库

### 权限问题

**症状表现：**
- 文件权限不足错误
- 无法创建或修改数据库文件
- iCloud同步权限问题

**排查步骤：**
1. 检查文件权限
   ```bash
   ls -la ~/Library/Mobile\ Documents/com~apple~CloudDocs/InvestLog/
   ```

2. 验证目录所有权
   - 确认用户权限
   - 检查组权限设置

3. 测试写入权限
   ```bash
   touch ~/Library/Mobile\ Documents/com~apple~CloudDocs/InvestLog/test.db
   ```

**解决方案：**
- 调整文件权限设置
- 重新授权iCloud访问
- 使用替代存储位置

**章节来源**
- [database.py](file://database.py#L15-L19)
- [config.py](file://config.py#L14-L15)

## Web界面访问异常排查

### 静态文件加载问题

**症状表现：**
- CSS样式文件无法加载
- 图标资源404错误
- 页面布局错乱

**排查步骤：**
1. 检查静态文件挂载
   - 验证/static路径映射
   - 确认文件存在性

2. 检查文件权限
   ```bash
   ls -la static/
   ```

3. 验证CSS文件内容
   - 检查style.css完整性
   - 确认编码格式正确

**解决方案：**
- 重新部署静态文件
- 检查文件路径配置
- 清除浏览器缓存

**章节来源**
- [app.py](file://app.py#L15-L16)
- [templates/base.html](file://templates/base.html#L7)

### 模板渲染错误

**症状表现：**
- 页面显示模板语法错误
- 变量未定义警告
- 页面空白或部分加载

**排查步骤：**
1. 检查Jinja2模板配置
   - 验证模板目录设置
   - 确认模板文件存在

2. 分析模板变量
   - 检查传递给模板的数据
   - 验证变量命名一致性

3. 启用模板调试模式
   ```python
   templates.env.debug = True
   ```

**解决方案：**
- 修正模板语法错误
- 补充缺失的模板变量
- 更新模板文件格式

**章节来源**
- [routers/utils.py](file://routers/utils.py#L1-L4)
- [templates/base.html](file://templates/base.html#L1-L27)

### 路由配置问题

**症状表现：**
- 页面404错误
- 路由重定向循环
- API端点不可访问

**排查步骤：**
1. 检查路由注册
   - 验证所有路由器已包含
   - 确认路由前缀正确

2. 分析URL路径
   - 检查静态资源路径
   - 验证动态参数匹配

3. 测试路由可达性
   ```bash
   curl http://localhost:8000/
   curl http://localhost:8000/api/holdings
   ```

**解决方案：**
- 修正路由注册顺序
- 调整URL路径配置
- 实现路由冲突检测

**章节来源**
- [app.py](file://app.py#L24-L29)
- [routers/api.py](file://routers/api.py#L6)

## 性能问题诊断

### 响应缓慢问题

**症状表现：**
- 页面加载时间过长
- API响应延迟增加
- 数据库查询超时

**排查步骤：**
1. 分析性能瓶颈
   - 使用性能分析工具
   - 监控数据库查询时间

2. 检查索引使用
   ```sql
   EXPLAIN QUERY PLAN SELECT * FROM transactions WHERE symbol = ?;
   ```

3. 评估内存使用
   - 监控Python进程内存
   - 分析对象生命周期

**解决方案：**
- 优化数据库查询语句
- 实现查询结果缓存
- 调整并发连接数

### 内存泄漏问题

**症状表现：**
- 内存使用持续增长
- 应用程序最终崩溃
- 垃圾回收频繁触发

**排查步骤：**
1. 监控内存使用趋势
   ```python
   import tracemalloc
   tracemalloc.start()
   ```

2. 分析对象引用链
   - 检查数据库连接泄漏
   - 验证模板对象清理

3. 实施内存监控
   ```python
   import psutil
   process = psutil.Process()
   print(process.memory_info().rss / 1024 / 1024, "MB")
   ```

**解决方案：**
- 确保数据库连接正确关闭
- 实现资源上下文管理
- 优化大对象处理逻辑

### CPU占用过高

**症状表现：**
- CPU使用率持续高位
- 系统响应迟缓
- 热点函数调用频繁

**排查步骤：**
1. 使用性能分析器
   ```bash
   python -m cProfile -o profile.prof app.py
   ```

2. 分析热点函数
   - 识别高耗时操作
   - 检查循环和递归调用

3. 监控并发处理
   - 检查异步任务数量
   - 分析线程池使用情况

**解决方案：**
- 优化算法复杂度
- 实现异步处理
- 调整并发参数

## 错误日志分析

### 日志配置与结构

**日志配置特点：**
- 按天轮转的日志文件
- 保留最近7天的日志
- 控制台和文件双重输出
- 标准化的时间戳格式

**日志文件位置：**
- 默认日志目录：`logs/`
- 文件命名：`app.log.YYYY-MM-DD`
- 备份保留：7天

**章节来源**
- [logger_config.py](file://logger_config.py#L11-L54)

### 常见错误类型识别

**启动阶段错误：**
- 端口绑定失败
- 依赖导入异常
- 数据库连接错误

**运行时错误：**
- 数据库操作异常
- 网络请求失败
- 模板渲染错误

**性能相关错误：**
- 查询超时
- 内存不足
- 并发冲突

### 日志分析技巧

**快速定位问题：**
1. 按时间范围筛选
2. 关键字搜索（ERROR, WARNING）
3. 进程ID关联分析

**日志解读要点：**
- 时间戳准确性验证
- 错误堆栈信息提取
- 相关操作上下文分析

**章节来源**
- [logger_config.py](file://logger_config.py#L14-L50)

## 调试工具使用

### 开发环境调试

**推荐调试工具：**
- Python内置pdb调试器
- FastAPI内置调试模式
- SQLite数据库管理工具

**调试配置建议：**
```python
# 启用调试模式
uvicorn.run(app, debug=True)

# 在代码中添加断点
import pdb; pdb.set_trace()
```

### 数据库调试

**SQL调试技巧：**
1. 启用SQLite详细日志
2. 使用EXPLAIN QUERY PLAN分析
3. 实现自定义SQL执行日志

**数据验证方法：**
- 手动查询关键表结构
- 验证数据完整性约束
- 检查索引使用效率

### 网络调试

**网络问题诊断：**
1. 使用curl测试API端点
2. 检查HTTP状态码和响应头
3. 分析请求和响应数据

**DNS和网络测试：**
```bash
# 测试域名解析
nslookup sina.com.cn

# 测试网络连通性
ping -c 4 qt.gtimg.cn

# 检查端口连通性
telnet hq.sinajs.cn 80
```

## 问题分类与优先级处理

### 问题严重程度分级

**紧急问题（P0）：**
- 应用完全无法启动
- 数据库完全不可用
- 核心功能完全失效

**高优先级问题（P1）：**
- 部分功能不可用
- 数据丢失风险
- 性能严重下降

**中等优先级问题（P2）：**
- 功能受限但可使用
- 用户体验影响
- 维护成本较高

**低优先级问题（P3）：**
- 界面小问题
- 边缘功能异常
- 文档和配置问题

### 处理流程标准化

**问题报告标准：**
1. 重现步骤详细描述
2. 环境信息完整提供
3. 错误日志准确附带
4. 影响范围明确说明

**问题解决流程：**
1. 问题分类和优先级确定
2. 根因分析和验证
3. 解决方案制定和实施
4. 测试验证和回归检查
5. 文档更新和知识分享

**问题跟踪机制：**
- 使用问题跟踪系统
- 建立问题解决时间线
- 实施预防措施
- 分享最佳实践

## 预防性维护建议

### 系统监控建议

**关键指标监控：**
- 应用健康状态
- 数据库性能指标
- 网络连接稳定性
- 磁盘空间使用率

**自动化检查：**
- 定期数据库完整性检查
- 系统资源使用监控
- 日志文件大小管理
- 备份验证和测试

### 最佳实践建议

**代码质量保证：**
- 实现输入验证和清理
- 添加适当的异常处理
- 使用连接池管理数据库连接
- 实现资源自动清理机制

**运维管理规范：**
- 建立定期维护计划
- 实施变更管理流程
- 准备应急响应预案
- 维护技术文档和知识库

**安全防护措施：**
- 定期更新依赖库
- 实施访问控制机制
- 加强数据备份策略
- 监控异常访问行为

通过遵循本指南的故障排除方法和预防性维护建议，用户可以有效识别和解决投资日志管理系统中的各种问题，确保系统的稳定运行和数据的完整性。