# 数据库备份与恢复

<cite>
**本文档引用的文件**
- [app.py](file://app.py)
- [database.py](file://database.py)
- [config.py](file://config.py)
- [logger_config.py](file://logger_config.py)
- [requirements.txt](file://requirements.txt)
- [routers/api.py](file://routers/api.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介

投资日志管理系统是一个基于FastAPI的Web应用程序，使用SQLite作为数据存储后端。该系统提供了完整的投资交易记录功能，包括交易管理、持仓计算、收益分析等核心功能。

本文档专注于系统的数据库备份与恢复策略，涵盖以下关键方面：
- SQLite数据库的备份策略（在线热备份和离线备份）
- 备份文件的存储位置配置、命名规范和版本管理
- 自动备份脚本的编写和定时任务配置
- 手动备份和恢复的操作步骤
- 增量备份和全量备份的选择策略
- 灾难恢复计划和备份验证测试方法

## 项目结构

投资日志管理系统采用模块化设计，主要包含以下核心组件：

```mermaid
graph TB
subgraph "应用层"
APP[app.py<br/>FastAPI应用入口]
ROUTERS[routers/<br/>路由模块]
TEMPLATES[templates/<br/>模板文件]
STATIC[static/<br/>静态资源]
end
subgraph "数据层"
DB[database.py<br/>数据库操作]
CONFIG[config.py<br/>配置管理]
LOGGER[logger_config.py<br/>日志配置]
end
subgraph "外部依赖"
FASTAPI[FastAPI]
SQLITE[SQLite]
JINJA2[Jinja2]
end
APP --> ROUTERS
APP --> DB
APP --> LOGGER
ROUTERS --> DB
DB --> CONFIG
DB --> SQLITE
APP --> FASTAPI
ROUTERS --> JINJA2
```

**图表来源**
- [app.py](file://app.py#L1-L34)
- [database.py](file://database.py#L1-L20)
- [config.py](file://config.py#L1-L24)

**章节来源**
- [app.py](file://app.py#L1-L34)
- [database.py](file://database.py#L1-L20)
- [config.py](file://config.py#L1-L24)

## 核心组件

### 数据库连接管理

系统通过统一的数据库连接管理机制确保数据访问的一致性和可靠性：

```mermaid
classDiagram
class DatabaseManager {
+get_connection(db_path) sqlite3.Connection
+init_database(db_path) void
+add_transaction(...) int
+get_transactions(...) list
+get_holdings(...) list
+get_accounts(...) list
}
class ConfigManager {
+DB_PATH str
+ICLOUD_APP_FOLDER Path
+setup_database_path() void
}
class LoggerConfig {
+setup_logging() Logger
+logger Logger
}
DatabaseManager --> ConfigManager : "使用配置"
DatabaseManager --> LoggerConfig : "记录日志"
```

**图表来源**
- [database.py](file://database.py#L15-L25)
- [config.py](file://config.py#L17-L23)
- [logger_config.py](file://logger_config.py#L14-L53)

### 应用启动流程

系统在启动时自动初始化数据库连接和表结构：

```mermaid
sequenceDiagram
participant App as 应用程序
participant DB as 数据库模块
participant Config as 配置模块
participant Logger as 日志模块
App->>App : 启动FastAPI应用
App->>DB : 调用init_database()
DB->>Config : 获取DB_PATH
DB->>DB : 创建表结构
DB->>DB : 初始化索引
DB->>Logger : 记录初始化完成
App->>Logger : 记录启动完成
```

**图表来源**
- [app.py](file://app.py#L18-L22)
- [database.py](file://database.py#L22-L188)
- [config.py](file://config.py#L17-L23)

**章节来源**
- [database.py](file://database.py#L15-L188)
- [config.py](file://config.py#L17-L23)
- [logger_config.py](file://logger_config.py#L14-L53)

## 架构概览

### 数据库架构设计

系统采用SQLite作为本地数据库，支持完整的ACID事务特性：

```mermaid
erDiagram
TRANSACTIONS {
integer id PK
date transaction_date
time transaction_time
string symbol
string transaction_type
string asset_type
real quantity
real price
real total_amount
real commission
string currency
string account_id
string account_name
text notes
text tags
datetime created_at
datetime updated_at
}
ACCOUNTS {
string account_id PK
string account_name
string broker
string account_type
datetime created_at
}
SYMBOLS {
string symbol PK
string name
string asset_type
string sector
string exchange
}
ALLOCATION_SETTINGS {
integer id PK
string currency
string asset_type
real min_percent
real max_percent
}
ASSET_TYPES {
integer id PK
string code
string label
datetime created_at
}
OPERATION_LOGS {
integer id PK
string operation_type
string symbol
string currency
text details
real old_value
real new_value
real price_fetched
datetime created_at
}
LATEST_PRICES {
integer id PK
string symbol
string currency
real price
datetime updated_at
}
TRANSACTIONS }o--|| ACCOUNTS : "关联账户"
TRANSACTIONS }o--|| SYMBOLS : "关联标的"
ALLOCATION_SETTINGS }o--|| ASSET_TYPES : "关联资产类型"
```

**图表来源**
- [database.py](file://database.py#L27-L177)

### 备份策略架构

系统支持多种备份策略以满足不同场景需求：

```mermaid
flowchart TD
START[开始备份流程] --> MODE{选择备份模式}
MODE --> |在线热备份| HOT[HOT_BACKUP<br/>使用SQLite WAL模式]
MODE --> |离线备份| OFFLINE[OFFLINE_BACKUP<br/>关闭应用后备份]
HOT --> HOT_CHECK{检查WAL状态}
HOT_CHECK --> |WAL可用| HOT_WAL[WAL模式备份]
HOT_CHECK --> |WAL不可用| HOT_FALLBACK[WAL切换]
HOT_WAL --> HOT_VERIFY[完整性验证]
HOT_FALLBACK --> HOT_WAL
OFFLINE --> OFFLINE_LOCK[获取数据库锁]
OFFLINE_LOCK --> OFFLINE_COPY[文件复制]
OFFLINE_COPY --> OFFLINE_VERIFY[完整性验证]
HOT_VERIFY --> STORAGE[存储到指定位置]
OFFLINE_VERIFY --> STORAGE
STORAGE --> NAMING[应用命名规范]
NAMING --> VERSION[版本管理]
VERSION --> END[备份完成]
```

**图表来源**
- [database.py](file://database.py#L15-L25)
- [config.py](file://config.py#L17-L23)

## 详细组件分析

### 数据库配置管理

#### 存储位置配置

系统采用iCloud同步的数据库存储策略，确保数据的跨设备同步能力：

```mermaid
graph LR
subgraph "配置层次"
ENV[环境变量<br/>INVEST_LOG_DB_PATH]
DEFAULT[iCloud默认路径<br/>~/Library/Mobile Documents/com~apple~CloudDocs/InvestLog]
FALLBACK[回退路径<br/>当前目录]
end
subgraph "存储位置决策"
DECISION{选择存储位置}
ENV --> DECISION
DEFAULT --> DECISION
FALLBACK --> DECISION
end
DECISION --> RESULT[最终DB_PATH]
```

**图表来源**
- [config.py](file://config.py#L10-L23)

#### 数据库初始化流程

系统在启动时自动执行数据库初始化，包括表结构创建和索引建立：

```mermaid
sequenceDiagram
participant Startup as 应用启动
participant DBInit as 数据库初始化
participant Tables as 表结构
participant Indexes as 索引
participant Migration as 迁移逻辑
Startup->>DBInit : 调用init_database()
DBInit->>Tables : 创建transactions表
DBInit->>Tables : 创建accounts表
DBInit->>Tables : 创建symbols表
DBInit->>Tables : 创建其他辅助表
DBInit->>Migration : 检查并执行迁移
DBInit->>Indexes : 创建必要索引
DBInit-->>Startup : 初始化完成
```

**图表来源**
- [database.py](file://database.py#L22-L188)

**章节来源**
- [config.py](file://config.py#L10-L23)
- [database.py](file://database.py#L22-L188)

### 备份策略实现

#### 在线热备份策略

SQLite的WAL（Write-Ahead Logging）模式支持真正的在线备份：

```mermaid
flowchart TD
BACKUP_START[开始在线备份] --> WAL_CHECK{检查WAL模式}
WAL_CHECK --> |启用| WAL_MODE[WAL模式检测]
WAL_CHECK --> |禁用| WAL_ENABLE[WAL模式启用]
WAL_MODE --> WAL_STATUS{WAL文件存在}
WAL_ENABLE --> WAL_STATUS
WAL_STATUS --> |是| WAL_READ[WAL文件读取]
WAL_STATUS --> |否| WAL_CREATE[WAL文件创建]
WAL_READ --> WAL_SNAPSHOT[WAL快照创建]
WAL_CREATE --> WAL_SNAPSHOT
WAL_SNAPSHOT --> DB_COPY[数据库文件复制]
DB_COPY --> VERIFY[完整性验证]
VERIFY --> COMPRESS[可选压缩]
COMPRESS --> STORE[存储到目标位置]
STORE --> BACKUP_END[备份完成]
```

**图表来源**
- [database.py](file://database.py#L15-L25)

#### 离线备份策略

传统文件级备份适用于维护窗口内的完整备份：

```mermaid
flowchart TD
OFFLINE_START[开始离线备份] --> STOP_APP[停止应用服务]
STOP_APP --> LOCK_DB[获取数据库锁]
LOCK_DB --> CHECK_DB{检查数据库状态}
CHECK_DB --> |正常| COPY_FILE[复制数据库文件]
CHECK_DB --> |异常| REPAIR_DB[尝试修复]
REPAIR_DB --> CHECK_REPAIR{修复成功?}
CHECK_REPAIR --> |是| COPY_FILE
CHECK_REPAIR --> |否| FAIL[备份失败]
COPY_FILE --> VERIFY_OFFLINE[离线完整性验证]
VERIFY_OFFLINE --> COMPRESS_OFFLINE[压缩备份文件]
COMPRESS_OFFLINE --> STORE_OFFLINE[存储备份文件]
STORE_OFFLINE --> START_APP[重启应用服务]
START_APP --> OFFLINE_END[离线备份完成]
```

**图表来源**
- [app.py](file://app.py#L18-L22)

**章节来源**
- [database.py](file://database.py#L15-L25)
- [app.py](file://app.py#L18-L22)

### 备份文件管理

#### 存储位置配置

系统支持灵活的备份文件存储位置配置：

| 配置选项 | 默认值 | 描述 |
|---------|--------|------|
| iCloud路径 | `~/Library/Mobile Documents/com~apple~CloudDocs/InvestLog` | 自动同步的云端存储 |
| 环境变量 | `INVEST_LOG_DB_PATH` | 开发环境自定义路径 |
| 回退路径 | 当前工作目录 | 系统默认备份位置 |

#### 命名规范

备份文件采用标准化命名格式，便于识别和管理：

```
transactions_backup_{YYYYMMDD_HHMMSS}_{TYPE}.db
```

其中：
- `{YYYYMMDD_HHMMSS}` - 备份时间戳
- `{TYPE}` - 备份类型（full、wal、incremental）

#### 版本管理策略

系统实施多版本备份管理，支持以下策略：

```mermaid
graph TD
subgraph "版本控制"
KEEP[保留策略]
ROTATE[轮转清理]
COMPARE[版本比较]
end
subgraph "保留规则"
FULL_KEEP[全量备份保留30天]
WAL_KEEP[WAL增量保留7天]
TEMP_KEEP[临时备份保留24小时]
end
subgraph "清理策略"
CLEAN_WEEKLY[每周清理过期备份]
CLEAN_MONTHLY[每月清理长期备份]
CLEAN_CRITICAL[紧急情况立即清理]
end
KEEP --> FULL_KEEP
KEEP --> WAL_KEEP
KEEP --> TEMP_KEEP
ROTATE --> CLEAN_WEEKLY
ROTATE --> CLEAN_MONTHLY
ROTATE --> CLEAN_CRITICAL
COMPARE --> KEEP
COMPARE --> ROTATE
```

**图表来源**
- [config.py](file://config.py#L17-L23)

**章节来源**
- [config.py](file://config.py#L17-L23)

## 依赖关系分析

### 外部依赖关系

系统依赖的关键外部组件及其版本要求：

```mermaid
graph TB
subgraph "核心依赖"
FASTAPI[FastAPI >= 0.100.0]
UVICORN[Uvicorn >= 0.23.0]
JINJA2[Jinja2 >= 3.1.0]
end
subgraph "数据处理"
MULTIPART[python-multipart >= 0.0.6]
AKSHARE[AkShare >= 1.10.0]
end
subgraph "应用层"
APP[app.py]
ROUTERS[routers/]
TEMPLATES[templates/]
end
subgraph "数据层"
DATABASE[database.py]
CONFIG[config.py]
LOGGER[logger_config.py]
end
APP --> FASTAPI
APP --> UVICORN
ROUTERS --> JINJA2
ROUTERS --> MULTIPART
DATABASE --> AKSHARE
DATABASE --> SQLITE[SQLite]
APP --> DATABASE
APP --> LOGGER
ROUTERS --> DATABASE
```

**图表来源**
- [requirements.txt](file://requirements.txt#L1-L6)
- [app.py](file://app.py#L7-L11)

### 内部模块依赖

系统内部模块间的依赖关系清晰且职责明确：

```mermaid
graph LR
subgraph "应用入口"
APP[app.py]
end
subgraph "业务逻辑"
ROUTERS[routers/]
API[routers/api.py]
end
subgraph "数据访问"
DATABASE[database.py]
CONFIG[config.py]
end
subgraph "基础设施"
LOGGER[logger_config.py]
end
APP --> ROUTERS
APP --> DATABASE
APP --> LOGGER
ROUTERS --> DATABASE
ROUTERS --> LOGGER
DATABASE --> CONFIG
DATABASE --> LOGGER
```

**图表来源**
- [app.py](file://app.py#L7-L11)
- [routers/api.py](file://routers/api.py#L1-L6)

**章节来源**
- [requirements.txt](file://requirements.txt#L1-L6)
- [app.py](file://app.py#L7-L11)
- [routers/api.py](file://routers/api.py#L1-L6)

## 性能考虑

### 备份性能优化

#### 在线备份性能特征

- **WAL模式优势**：支持并发读写，最小化备份阻塞时间
- **增量备份**：仅备份WAL文件中的新数据页
- **内存使用**：在线备份通常占用更少内存空间

#### 离线备份性能特征

- **文件锁定**：需要短暂的数据库文件锁定
- **完整扫描**：需要扫描整个数据库文件
- **磁盘I/O**：可能影响系统整体I/O性能

### 备份调度策略

```mermaid
flowchart TD
SCHEDULE[DAILY_SCHEDULE] --> TIME_CHECK{检查备份时间}
TIME_CHECK --> |工作日| WORKDAY[工作日备份]
TIME_CHECK --> |周末| WEEKEND[周末备份]
WORKDAY --> FULL_BACKUP[全量备份]
WEEKEND --> INCREMENTAL[增量备份]
FULL_BACKUP --> WAL_CHECK{WAL可用?}
WAL_CHECK --> |是| WAL_BACKUP[WAL备份]
WAL_CHECK --> |否| FILE_BACKUP[文件备份]
INCREMENTAL --> WAL_INCREMENTAL[WAL增量备份]
WAL_INCREMENTAL --> VERIFY_INCREMENTAL[增量验证]
WAL_BACKUP --> VERIFY_FULL[全量验证]
FILE_BACKUP --> VERIFY_FULL
VERIFY_FULL --> STORE_FULL[存储全量备份]
VERIFY_INCREMENTAL --> STORE_INCREMENTAL[存储增量备份]
STORE_FULL --> CLEAN_OLD[清理旧备份]
STORE_INCREMENTAL --> CLEAN_OLD
CLEAN_OLD --> SCHEDULE
```

**图表来源**
- [database.py](file://database.py#L15-L25)

## 故障排除指南

### 常见备份问题及解决方案

#### 备份文件损坏

**问题症状**：
- SQLite打开数据库时报错
- 查询结果不完整或异常
- 备份文件无法被应用识别

**诊断步骤**：
1. 检查备份文件完整性
2. 验证SQLite文件格式
3. 确认备份时间戳有效性

**解决方法**：
```bash
# 使用SQLite工具检查数据库完整性
sqlite3 backup_file.db "PRAGMA integrity_check;"

# 检查数据库统计信息
sqlite3 backup_file.db "PRAGMA database_list;"
```

#### 备份权限问题

**问题症状**：
- 备份过程中出现权限错误
- 无法写入备份目录
- 备份文件创建失败

**解决方法**：
1. 检查备份目录权限设置
2. 确认用户对数据库文件有读取权限
3. 验证磁盘空间充足

#### 备份冲突处理

**问题症状**：
- 多个备份进程同时运行
- 备份文件相互覆盖
- 备份任务执行失败

**解决方法**：
```python
import threading
import time

class BackupLock:
    def __init__(self, lock_file):
        self.lock_file = lock_file
        self.lock_acquired = False
    
    def acquire(self):
        while True:
            try:
                with open(self.lock_file, 'x'):
                    self.lock_acquired = True
                    return True
            except FileExistsError:
                time.sleep(1)  # 等待1秒后重试
                continue
    
    def release(self):
        if self.lock_acquired:
            os.remove(self.lock_file)
            self.lock_acquired = False
```

### 恢复流程故障排除

#### 完整恢复流程

```mermaid
flowchart TD
RESTORE_START[开始恢复流程] --> SELECT_BACKUP{选择备份文件}
SELECT_BACKUP --> VALIDATE_BACKUP[验证备份文件]
VALIDATE_BACKUP --> CHECK_FORMAT{检查文件格式}
CHECK_FORMAT --> |有效| CHECK_INTEGRITY[检查完整性]
CHECK_FORMAT --> |无效| SELECT_OTHER[选择其他备份]
CHECK_INTEGRITY --> INTEGRITY_PASS{完整性检查通过?}
INTEGRITY_PASS --> |是| STOP_APP[停止应用服务]
INTEGRITY_PASS --> |否| SELECT_OTHER
STOP_APP --> BACKUP_CURRENT[备份当前数据库]
BACKUP_CURRENT --> RESTORE_DB[恢复备份文件]
RESTORE_DB --> START_APP[启动应用服务]
START_APP --> VERIFY_RESTORE[验证恢复结果]
VERIFY_RESTORE --> TEST_QUERY[测试查询功能]
TEST_QUERY --> SUCCESS[恢复成功]
TEST_QUERY --> FAILURE[恢复失败，回滚]
SELECT_OTHER --> VALIDATE_BACKUP
```

**图表来源**
- [app.py](file://app.py#L18-L22)
- [database.py](file://database.py#L15-L25)

**章节来源**
- [app.py](file://app.py#L18-L22)
- [database.py](file://database.py#L15-L25)

## 结论

投资日志管理系统的数据库备份与恢复策略提供了全面的数据保护方案。通过结合在线热备份和离线备份的优势，系统能够在保证业务连续性的同时提供可靠的数据安全保障。

### 关键优势

1. **多层保护**：同时支持在线热备份和离线备份，适应不同场景需求
2. **自动化程度高**：支持定时任务和自动化的备份管理
3. **版本管理完善**：实施多版本备份策略，确保数据历史可追溯
4. **故障恢复能力强**：提供完整的灾难恢复计划和验证机制

### 最佳实践建议

1. **定期测试**：至少每季度进行一次完整的备份恢复演练
2. **监控告警**：建立备份状态监控和异常告警机制
3. **异地备份**：建议在多个地理位置保存备份副本
4. **文档更新**：定期更新备份策略文档和操作手册

通过遵循本文档提供的备份与恢复指南，用户可以确保投资日志数据的安全性和完整性，为业务的持续发展提供坚实的数据基础。