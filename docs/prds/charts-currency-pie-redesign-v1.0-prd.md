# Charts页面币种环图重构 - 产品需求文档 (PRD)

## 需求描述

### 背景
- **业务问题**: 当前Charts页面的资产展示方式未能清晰呈现账户维度的资产分布，用户难以快速了解每个账户下各标的的占比情况
- **目标用户**: 投资组合管理者，需要按账户维度查看资产配置
- **价值主张**: 提供更直观的账户-标的层级视图，帮助用户快速理解资产在不同账户间的分布

### 功能概述
- **核心功能**:
  - 按币种横向并排展示环图
  - 环图下方按账户分组展示标的列表
  - 账户标题行显示累计金额和占比
  - 点击标的行时环图对应扇区高亮

- **功能边界**:
  - 包含：环图展示、账户分组列表、交互高亮
  - 不包含：历史趋势图、账户间资产转移功能

- **用户场景**:
  - 用户打开Charts页面，看到各币种资产环图横向排列
  - 每个环图下方是按账户分组的标的列表
  - 用户点击某个标的，环图中对应扇区突出高亮

### 详细需求

#### 输入/输出
- **输入**: `/api/holdings-by-symbol` 返回的持仓数据
- **输出**:
  - 按币种分组的环图（每个标的一个扇区）
  - 按账户分组的标的列表

#### 用户交互
1. 页面加载后，横向并排显示所有有持仓的币种环图
2. 每个环图下方显示该币种的标的列表，按账户分组
3. 点击标的行 → 环图对应扇区向外突出 + 显示tooltip
4. 无持仓的账户不显示

#### 数据要求

**账户分组排序**:
- 账户之间：按账户累计市值从大到小排序
- 账户内标的：按占比从大到小排序

**账户标题行显示**:
```
{账户名称}  {累计金额}  {占比}%
```
示例：`招商证券  ¥85,000.00  57.3%`

**标的行显示字段**:
| 字段 | 说明 |
|------|------|
| 标的名称 | display_name |
| 代码 | symbol |
| 金额 | market_value |
| 占比 | 该标的市值 / 该币种总市值 |
| 盈亏 | unrealized_pnl |

#### 视觉样式
- **账户分组**: 背景色交替区分不同账户
- **环图高亮**: 扇区向外突出 + 显示tooltip（标的名称、金额、占比）
- **多币种布局**: 横向并排展示

#### 边界情况
- 某币种下无持仓 → 不显示该币种环图
- 某账户在该币种下无持仓 → 不显示该账户分组
- 只有一个币种 → 居中显示单个环图

## 设计决策

### 技术方案
- **架构选择**: 复用现有SPA架构，修改 `renderCharts()` 函数
- **关键组件**:
  - 环图渲染：复用现有 `renderPieChart()` 函数
  - 数据处理：新增按账户分组逻辑
  - 交互处理：新增点击高亮逻辑
- **数据来源**: 复用 `/api/holdings-by-symbol` API
- **界面设计**: 纯CSS实现，无需额外依赖

### 约束条件
- **性能要求**: 页面加载时间 < 500ms
- **兼容性**: 支持现有浏览器环境
- **安全性**: 无新增安全风险（纯前端展示）
- **可扩展性**: 保持代码结构清晰，便于后续添加新图表类型

### 风险评估
- **技术风险**: 环图高亮动画可能需要调整SVG结构，风险较低
- **依赖风险**: 无外部依赖
- **进度风险**: 低，功能范围明确

## 验收标准

### 功能验收
- [ ] 页面加载后横向并排显示各币种环图
- [ ] 每个环图下方显示按账户分组的标的列表
- [ ] 账户按累计市值从大到小排序
- [ ] 标的按占比从大到小排序
- [ ] 账户标题行显示：账户名称 + 累计金额 + 占比
- [ ] 标的行显示：名称 + 代码 + 金额 + 占比 + 盈亏
- [ ] 账户分组背景色交替显示
- [ ] 点击标的行时，环图对应扇区向外突出并显示tooltip
- [ ] 无持仓的账户/币种不显示

### 质量标准
- [ ] 代码质量：遵循现有代码风格
- [ ] 测试覆盖：手动测试所有交互场景
- [ ] 性能指标：页面渲染流畅，无明显卡顿

### 用户验收
- [ ] 用户体验：布局清晰，信息层级分明
- [ ] 视觉一致性：与现有Holdings页面风格保持一致

## 执行阶段

### 阶段1：数据处理
**目标**: 实现按账户分组的数据结构转换
- [ ] 解析 holdings-by-symbol 数据
- [ ] 按账户分组并计算账户汇总
- [ ] 实现排序逻辑（账户按市值、标的按占比）
- **交付物**: 数据处理函数
- **预计工作量**: 小

### 阶段2：布局重构
**目标**: 实现新的页面布局
- [ ] 修改 renderCharts() 函数
- [ ] 实现横向并排的币种环图布局
- [ ] 实现账户分组列表结构
- [ ] 添加背景色交替样式
- **交付物**: 新的Charts页面布局
- **预计工作量**: 中

### 阶段3：交互实现
**目标**: 实现点击高亮交互
- [ ] 为标的行添加点击事件
- [ ] 实现环图扇区突出动画
- [ ] 实现tooltip显示
- **交付物**: 完整的交互功能
- **预计工作量**: 中

### 阶段4：测试与优化
**目标**: 确保功能完整和性能达标
- [ ] 测试各种数据场景（多币种、单币种、空数据）
- [ ] 测试交互响应
- [ ] 优化视觉细节
- **交付物**: 可发布版本
- **预计工作量**: 小

---

**文档版本**: 1.0
**创建时间**: 2026-02-09
**澄清轮次**: 4
**质量评分**: 94/100
