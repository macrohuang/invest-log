# MRD：AI 持仓分析与建议（马尔基尔 + 达利欧 + 巴菲特）

> 文件名：`docs/specs/mrd-ai-holdings-analysis.md`

## 1. 背景与目标
- 背景问题：当前系统能展示持仓与盈亏，但缺少基于投资理念的可解释分析与调整建议，用户需要更高层的组合诊断能力。
- 业务目标：提供“一键分析当前持仓”的 AI 能力，输出风险识别、风格偏离、以及可执行的增减持/新增建议。
- 成功指标（可量化）：
  - 分析接口可用率 >= 99%（在配置正确情况下）。
  - 单次分析响应时间（后端）目标 <= 20s。
  - 输出包含不少于 3 条可执行建议（当持仓数量足够时）。

## 2. 用户与场景
- 目标用户：使用 Invest Log 管理多币种投资组合的个人投资者。
- 核心使用场景：用户在 Holdings 页面选择币种后，点击 AI 分析，输入（或使用已保存）模型与 API Key，获得结构化建议。
- 非目标用户：机构交易员、高频交易策略用户、量化研究员（本版本不做回测和自动交易）。

## 3. 范围定义
- In Scope：
  - 新增“AI 持仓分析”按钮和结果展示区（Holdings 页）。
  - 支持前端输入并本地保存 AI 配置（Model、API Key、Base URL）。
  - 后端新增 OpenAI 兼容协议分析接口。
  - 输出遵循三种理念：
    - 马尔基尔：分散化、指数化思路、降低非系统性风险。
    - 达利欧：风险平衡/全天候分散思路。
    - 巴菲特：能力圈、护城河、长期价值与估值纪律。
  - 支持到“具体标的级别”的增减持与新增建议（用户已确认允许点名标的）。
- Out of Scope：
  - 自动下单、券商联动。
  - 收益承诺与投资保证。
  - 多轮会话记忆与长期 AI 画像。

## 4. 需求明细
- 功能需求 FR-1：在 Holdings 币种面板新增 `AI Analyze` 操作。
- 功能需求 FR-2：点击后允许输入并缓存：`base_url`、`model`、`api_key`。
- 功能需求 FR-3：后端读取当前持仓快照（按币种/标的/仓位占比/盈亏等）并调用 OpenAI 兼容接口。
- 功能需求 FR-4：返回结构化结果，至少包含：
  - 总结（overall summary）
  - 风险等级与关键发现（key findings）
  - 标的级建议（symbol, action, rationale, theory tag, target weight）
- 功能需求 FR-5：前端以可读卡片形式展示分析结果，支持重复分析刷新。
- 功能需求 FR-6：默认分析偏好为：风险偏好=平衡、投资期限=中期、允许新增标的=是。
- 功能需求 FR-7：支持点名新增标的建议（例如 ETF/个股等）。
- 非功能需求 NFR-1（安全）：API Key 不落库，仅保存在浏览器本地（localStorage），后端不记录明文 Key。
- 非功能需求 NFR-2（兼容）：兼容 OpenAI Chat Completions 协议；支持自定义 Base URL。
- 非功能需求 NFR-3（可靠性）：对模型返回非 JSON 或空结果做友好错误提示。

## 5. 约束与依赖
- 技术约束：
  - 后端 Go + chi + SQLite，不引入重型新框架。
  - 前端为原生 SPA（`static/app.js`），不引入构建工具链。
- 数据约束：
  - 分析基于已有持仓与最新价格数据，不新增数据库表。
- 外部依赖：
  - 用户可访问的 OpenAI 兼容 API 服务。

## 6. 边界与异常
- 边界条件：
  - 无持仓时不触发分析，提示先录入持仓。
  - 持仓币种过滤：支持按当前面板币种分析。
- 异常处理：
  - API Key/model 缺失 -> 400。
  - 上游模型接口失败/超时 -> 502/400（可读错误）。
  - 模型返回无法解析 -> 502（提示重试或更换模型）。
- 失败回退：
  - 保留页面可操作性，不影响既有持仓功能。

## 7. 验收标准
- AC-1（可验证）：Holdings 页面存在 `AI Analyze` 按钮，点击可完成分析并展示结果。
- AC-2（可验证）：后端新增 `/api/ai/holdings-analysis` 接口，正确处理参数校验与错误分支。
- AC-3（可验证）：结果中包含标的级建议，且含理论标签（Malkiel/Dalio/Buffett）。
- AC-4（可验证）：自动化测试覆盖核心逻辑与 API 入口，变更后测试通过。

## 8. 待确认问题
- Q1：默认 Base URL 是否固定为 `https://api.openai.com/v1`（本版先采用该默认值，可手动覆盖）。
- Q2：建议语言默认中文（本版采用中文输出）。

## 9. 假设与决策记录
- 假设：用户具备可用的 OpenAI 兼容服务凭据，并接受“仅供参考”的建议性质。
- 决策：按用户确认使用“前端输入配置（B）”、“建议粒度 C”、“平衡 + 中期 + 允许新增标的”。
