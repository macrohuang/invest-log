# MRD：AI 分析增强（引入外部最新情报）

> 文件名：`docs/specs/ai-analysis/mrd-ai-analysis.md`

## 1. 背景与问题
- 当前 AI 标的分析与持仓分析主要依赖模型既有训练语料，存在信息陈旧问题。
- 现有流程缺少“最新公告/财报/行业资讯/研究观点”的结构化注入层。
- 在市场变化快、事件驱动强的场景下，分析结论时效性不足。

## 2. 目标
- 将 AI 分析流程升级为：**外部抓取 -> AI 提炼 -> AI 分析 -> 结构化输出**。
- 在不破坏现有 API 兼容性的前提下，增强标的分析与持仓分析两条链路。
- 输出可追溯（来源可见）且可审计（结果可回放）的分析结果。

## 3. 用户与核心场景
- 目标用户：使用 Invest Log 做多币种投资管理的个人投资者。
- 场景 A（标的分析）：用户点击某标的 AI 分析，系统先抓取该标的最新信息，再给出四维分析与综合建议。
- 场景 B（持仓分析）：用户分析组合时，系统先抓取组合关键标的与市场信息，再给出组合建议。

## 4. 范围定义
- In Scope：
  - `AnalyzeSymbol` 与 `AnalyzeHoldings` 统一接入外部情报层。
  - 仅接入权威白名单来源，不支持任意网页抓取。
  - 支持 `USD/HKD/CNY` 三个市场首版一次到位。
  - 支持来源阈值校验、缓存、来源回传与持久化。
  - 前端设置页新增相关参数可调。
- Out of Scope：
  - 自动交易与下单。
  - 任意站点开放式爬虫平台。
  - 复杂事件推理图谱与长周期知识库构建。

## 5. 关键产品决策（已锁定）
- 覆盖范围：全 AI 流程统一（标的 + 持仓）。
- 数据源策略：白名单权威源。
- 成功阈值：至少 `2` 个不同来源。
- 缓存时长：`24` 小时。
- 结果追溯：返回并持久化 `sources + pre_summary`。
- 配置方式：前端设置页可调。

## 6. 功能需求
- FR-1：新增外部情报开关与参数（启用、最小来源数、缓存时长、情报分类）。
- FR-2：分析前执行外部抓取，并进行去重、时效过滤与质量过滤。
- FR-3：外部信息先交给 AI 进行提炼，生成结构化 `external_context`。
- FR-4：维度分析与综合分析 prompt 必须注入 `external_context`。
- FR-5：当来源数小于阈值时，分析失败并返回明确错误原因。
- FR-6：分析结果返回并持久化外部来源及提炼摘要。
- FR-7：历史查询可查看当时使用的来源与摘要。

## 7. 非功能需求
- NFR-1（时效）：同一标的/组合在缓存窗口内复用结果，减少重复抓取。
- NFR-2（稳定）：对单个来源失败具备容错，最终按阈值统一判定。
- NFR-3（安全）：禁止抓取任意 URL，仅允许配置白名单来源。
- NFR-4（性能）：分析主流程整体响应时间可控，具备并发抓取与超时控制。
- NFR-5（可观测）：记录抓取成功率、来源覆盖数、缓存命中率、失败原因。

## 8. 成功指标
- 每次分析中外部情报注入成功率 >= 95%（配置正确、网络可达前提下）。
- `external_context` 返回覆盖率 = 100%（成功请求）。
- 缓存命中场景下平均响应时间较实时抓取显著下降。
- 在来源不足时，错误提示可读且可定位（来源数、阈值、失败摘要）。

## 9. 约束与依赖
- 后端保持 Go + SQLite 架构，不引入重型基础设施。
- 前端保持原生 SPA（`static/app.js`）架构。
- 依赖外部权威网站/API/RSS 的可用性与访问策略。

## 10. 验收标准
- AC-1：`/api/ai/symbol-analysis` 与 `/api/ai/holdings-analysis` 支持新增外部参数。
- AC-2：返回结果包含 `external_context`，并在历史接口可读。
- AC-3：当来源数 < 阈值时请求失败；>= 阈值时继续分析并成功返回。
- AC-4：设置页可调整外部参数，前后端参数传递正确。
- AC-5：自动化测试覆盖新增核心分支，且无既有回归。

## 11. 假设与默认值
- 默认启用外部情报：`external_data_enabled = true`。
- 默认最小来源数：`external_min_sources = 2`。
- 默认缓存：`external_cache_hours = 24`。
- 默认情报分类：`filing/announcement/news/research`。

