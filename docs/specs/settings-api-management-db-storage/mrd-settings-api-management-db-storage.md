# MRD：Settings API 管理非 Key 配置入库

## 1. 背景与目标
- 背景问题：当前 Settings > API 中的 AI 配置（`baseUrl/model/riskProfile/horizon/adviceStyle/allowNewSymbols/strategyPrompt/apiKey`）都存放在前端 `localStorage`，导致换端后配置不一致，且“业务配置”和“敏感密钥”没有分层管理。
- 业务目标：将 API Key 之外的 AI 配置信息持久化到数据库；API Key 继续仅在本地保存。
- 成功指标（可量化）：
  - 保存设置后，刷新页面仍可从后端读取到非 Key 配置。
  - 不同客户端连接同一数据库时，非 Key 配置保持一致。
  - 数据库中不出现 API Key 字段。

## 2. 用户与场景
- 目标用户：使用 Settings 管理 AI 分析参数的投资记录用户。
- 核心使用场景：用户在 Settings > API 修改 AI Base URL、Model、风险偏好等后，后续 AI 分析和下次打开应用都自动使用已保存配置。
- 非目标用户：需要多租户隔离、密钥托管/加密托管的企业管理员。

## 3. 范围定义
- In Scope：
  - 后端新增 AI 配置持久化（不含 API Key）的数据模型与读写接口。
  - 前端 Settings 页面改为通过后端读取/保存非 Key 配置。
  - 前端 API Key 改为独立本地存储，不入库。
  - 兼容旧版本地存储结构（至少不破坏旧用户读取 API Key）。
- Out of Scope：
  - API Key 加密管理、系统密钥服务集成。
  - 多用户/多工作区配置隔离。
  - 改造 AI 分析算法本身。

## 4. 需求明细
- 功能需求 FR-1：提供查询 AI 设置接口，返回除 API Key 外的完整 AI 配置。
- 功能需求 FR-2：提供保存 AI 设置接口，仅接收并持久化非 Key 字段。
- 功能需求 FR-3：前端执行 AI 分析时，使用“后端非 Key 配置 + 本地 API Key”组合请求。
- 功能需求 FR-4：Settings 页面保存后提示成功；当缺少 model 或 api key 时保持现有提示语义。
- 非功能需求 NFR-1（安全/可靠性）：API Key 不写入数据库，不通过新增设置接口回显；接口失败时返回可诊断错误。

## 5. 约束与依赖
- 技术约束：沿用现有 Go + SQLite + SPA 架构；遵循现有路由/handler/core 分层。
- 数据约束：新表需支持默认值和单行 upsert；现有数据库需平滑初始化。
- 外部依赖：无新增第三方依赖。

## 6. 边界与异常
- 边界条件：空 model 合法（允许保存），但运行分析时仍会拦截并提示未配置完整。
- 异常处理：后端设置接口失败时前端提示 `Save failed`，不覆盖本地 API Key。
- 失败回退：读取后端失败时前端回落到默认值 + 本地 API Key，避免分析流程崩溃。

## 7. 验收标准
- AC-1（可验证）：`GET /api/ai-settings` 与 `PUT /api/ai-settings` 可用，且数据库可见非 Key 字段持久化。
- AC-2（可验证）：`Settings > API` 保存后刷新页面，非 Key 字段保持；API Key 仍从本地输入框读取。
- AC-3（可验证）：AI 分析相关接口请求体仍包含 `api_key`，但该值来源为本地存储而非后端设置接口返回。

## 8. 待确认问题
- Q1：当前按“单库单配置”实现，是否需要未来扩展为按账号维度配置？（本次不做）
- Q2：是否需要在 UI 明确标识“API Key 仅本地保存”？（本次暂不新增文案）

## 9. 假设与决策记录
- 假设：用户本次需求中的“其余信息”指 AI 配置中的全部非 `apiKey` 字段。
- 决策：
  - 数据库新增单行配置表存储非 Key 字段。
  - API Key 改为独立本地键值存储。
  - 前端分析入口统一通过异步加载设置，确保优先读取数据库配置。
