{% extends "base.html" %}

{% block title %}Charts - Invest Log{% endblock %}

{% block content %}
<style>
    /* Privacy Mode Styles */
    .masked { display: none !important; }
    body.privacy-mode .unmasked { display: none !important; }
    body.privacy-mode .masked { display: inline !important; }
    
    .privacy-toggle {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1a1a2e;
        transition: opacity 0.2s;
    }
    .privacy-toggle:hover { opacity: 0.7; }
    .privacy-toggle svg { width: 24px; height: 24px; }
</style>

<div class="page-header">
    <h1>Portfolio Charts</h1>
    <button id="privacyToggle" class="privacy-toggle" title="Toggle Privacy Mode">
        <svg id="eyeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <!-- Icon will be set by JS -->
        </svg>
    </button>
</div>

{% if holdings_by_symbol %}
<div class="charts-grid">
    {% for currency, currency_data in holdings_by_symbol.items() %}
    <div class="chart-card">
        <div class="chart-header">
            <h3>{{ currency }} Holdings</h3>
            <span class="chart-total">
                <span class="unmasked">{% if currency == 'CNY' %}Â¥{% elif currency == 'USD' %}${% else %}HK${% endif %}{{ currency_data.total_market_value|format_currency }}</span>
                <span class="masked">****</span>
            </span>
        </div>
        <div class="chart-container">
            <canvas id="chart-{{ currency }}"></canvas>
        </div>
        <div class="chart-legend">
            {% for account_id, account_data in currency_data.get('by_account', {}).items() %}
            <div class="account-group">
                <h4 class="account-title">{{ account_data.account_name }}</h4>
                {% for sym in account_data.symbols %}
                <div class="legend-item">
                    <span class="legend-color" style="background: var(--color-{{ loop.index0 % 10 }})"></span>
                    <a href="/symbol/{{ sym.symbol }}?currency={{ currency }}" class="legend-label" title="{{ sym.symbol }}">{{ sym.display_name }}</a>
                    <span class="legend-value">{{ sym.percent }}%</span>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<style>
:root {
    --color-0: #3b82f6;
    --color-1: #10b981;
    --color-2: #f59e0b;
    --color-3: #8b5cf6;
    --color-4: #ef4444;
    --color-5: #06b6d4;
    --color-6: #ec4899;
    --color-7: #84cc16;
    --color-8: #f97316;
    --color-9: #6366f1;
}
.chart-legend .legend-label {
    color: var(--text-primary);
    text-decoration: none;
}
.chart-legend .legend-label:hover {
    text-decoration: underline;
}
.account-group {
    margin-bottom: 1rem;
}
.account-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin: 0.5rem 0 0.25rem 0;
    padding-left: 0.5rem;
    border-left: 3px solid var(--text-primary);
}
.account-group:first-child .account-title {
    margin-top: 0;
}
</style>

<script>
// Privacy Mode Logic
(function() {
    const privacyToggle = document.getElementById('privacyToggle');
    const body = document.body;
    const eyeIcon = document.getElementById('eyeIcon');

    function updateEyeIcon(isPrivacy) {
        if (isPrivacy) {
            eyeIcon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
        } else {
            eyeIcon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
        }
    }

    const isPrivacyStored = localStorage.getItem('privacyMode');
    const isPrivacyInitial = isPrivacyStored === null ? true : isPrivacyStored === 'true';

    if (isPrivacyInitial) {
        body.classList.add('privacy-mode');
    }
    updateEyeIcon(isPrivacyInitial);

    privacyToggle.addEventListener('click', () => {
        const isPrivacy = body.classList.toggle('privacy-mode');
        localStorage.setItem('privacyMode', isPrivacy);
        updateEyeIcon(isPrivacy);
    });
})();

const holdingsData = {{ holdings_by_symbol | tojson }};
const chartColors = [
    '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444',
    '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1'
];

// Render overall currency charts
Object.keys(holdingsData).forEach(currency => {
    const data = holdingsData[currency];
    const symbols = data.symbols.filter(s => s.market_value > 0);
    
    if (symbols.length > 0) {
        new Chart(document.getElementById('chart-' + currency), {
            type: 'doughnut',
            data: {
                labels: symbols.map(s => s.display_name || s.symbol),
                datasets: [{
                    data: symbols.map(s => s.market_value),
                    backgroundColor: symbols.map((_, i) => chartColors[i % chartColors.length])
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percent = ((value / total) * 100).toFixed(1);
                                return context.label + ': ' + percent + '%';
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% else %}
<div class="empty-state">
    <p>No holdings data to display. <a href="/add">Add a transaction</a> to get started.</p>
</div>
{% endif %}
{% endblock %}
