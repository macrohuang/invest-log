{% extends "base.html" %}

{% block title %}Holdings - Invest Log{% endblock %}

{% block content %}
<style>
    /* Privacy Mode Styles */
    .masked { display: none !important; }
    body.privacy-mode .unmasked { display: none !important; }
    body.privacy-mode .masked { display: inline !important; }
    
    .privacy-toggle {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1a1a2e;
        transition: opacity 0.2s;
    }
    .privacy-toggle:hover { opacity: 0.7; }
    .privacy-toggle svg { width: 24px; height: 24px; }
</style>

<div class="page-header">
    <h1>Portfolio Holdings</h1>
    <button id="privacyToggle" class="privacy-toggle" title="Toggle Privacy Mode">
        <svg id="eyeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <!-- Icon will be set by JS -->
        </svg>
    </button>
</div>

{% if holdings_by_currency %}
<div class="currency-charts">
    {% for currency, data in holdings_by_currency.items() %}
    <div class="currency-card">
        <div class="currency-header">
            <h2>{{ currency }}</h2>
            <span class="currency-total">
                <span class="unmasked">{% if currency == 'CNY' %}Â¥{% elif currency == 'USD' %}${% else %}HK${% endif %}{{ data.total|format_currency }}</span>
                <span class="masked">****</span>
            </span>
        </div>
        
        <div class="chart-container">
            <canvas id="chart-{{ currency }}"></canvas>
        </div>
        
        <div class="allocation-list">
            {% for alloc in data.allocations %}
            {% if alloc.amount > 0 or alloc.warning %}
            <div class="allocation-item {% if alloc.warning %}has-warning{% endif %}">
                <div class="allocation-info">
                    <span class="allocation-label">{{ alloc.label }}</span>
                    <span class="allocation-percent">{{ alloc.percent }}%</span>
                </div>
                <div class="allocation-bar-container">
                    <div class="allocation-bar" style="width: {{ alloc.percent }}%"></div>
                    {% if alloc.min_percent > 0 or alloc.max_percent < 100 %}
                    <div class="allocation-range" style="left: {{ alloc.min_percent }}%; width: {{ alloc.max_percent - alloc.min_percent }}%"></div>
                    {% endif %}
                </div>
                {% if alloc.warning %}
                <div class="allocation-warning">{{ alloc.warning }}</div>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
// Privacy Mode Logic
(function() {
    const privacyToggle = document.getElementById('privacyToggle');
    const body = document.body;
    const eyeIcon = document.getElementById('eyeIcon');

    function updateEyeIcon(isPrivacy) {
        if (isPrivacy) {
            eyeIcon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
        } else {
            eyeIcon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
        }
    }

    const isPrivacyStored = localStorage.getItem('privacyMode');
    const isPrivacyInitial = isPrivacyStored === null ? true : isPrivacyStored === 'true';

    if (isPrivacyInitial) {
        body.classList.add('privacy-mode');
    }
    updateEyeIcon(isPrivacyInitial);

    privacyToggle.addEventListener('click', () => {
        const isPrivacy = body.classList.toggle('privacy-mode');
        localStorage.setItem('privacyMode', isPrivacy);
        updateEyeIcon(isPrivacy);
    });
})();

const holdingsData = {{ holdings_by_currency | tojson }};
const colors = {
    'stock': '#3b82f6',
    'bond': '#10b981',
    'metal': '#f59e0b',
    'cash': '#8b5cf6'
};
const labels = {{ asset_type_labels | tojson }};

Object.keys(holdingsData).forEach(currency => {
    const data = holdingsData[currency];
    const allocations = data.allocations.filter(a => a.amount > 0);
    
    if (allocations.length > 0) {
        new Chart(document.getElementById('chart-' + currency), {
            type: 'doughnut',
            data: {
                labels: allocations.map(a => a.label),
                datasets: [{
                    data: allocations.map(a => a.amount),
                    backgroundColor: allocations.map(a => colors[a.asset_type])
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
});
</script>

{% else %}
<div class="empty-state">
    <p>No holdings yet. <a href="/add">Add a transaction</a> to get started.</p>
</div>
{% endif %}
{% endblock %}
