{% extends "base.html" %}

{% block title %}Add Transaction - Invest Log{% endblock %}

{% block content %}
<h1>Add Transaction</h1>

<form method="POST" action="/add" class="form">
    <div class="form-row">
        <div class="form-group">
            <label for="transaction_date">Date</label>
            <input type="date" id="transaction_date" name="transaction_date" value="{{ today }}" required>
        </div>
        <div class="form-group">
            <label for="transaction_type">Type</label>
            <select id="transaction_type" name="transaction_type" required>
                <option value="BUY">BUY</option>
                <option value="SELL">SELL</option>
                <option value="INCOME">INCOME (Cash)</option>
                <option value="DIVIDEND">DIVIDEND</option>
                <option value="SPLIT">SPLIT</option>
                <option value="TRANSFER_IN">TRANSFER_IN</option>
                <option value="TRANSFER_OUT">TRANSFER_OUT</option>
                <option value="ADJUST">ADJUST</option>
            </select>
        </div>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="asset_type">Asset Type</label>
            <select id="asset_type" name="asset_type" required>
                {% for at in asset_types %}
                <option value="{{ at.code }}" {% if at.code == 'stock' %}selected{% endif %}>{{ at.label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group" id="symbol-container">
            <label for="symbol">Symbol</label>
            <div id="symbol-input-wrapper">
                <input type="text" id="symbol" name="symbol" placeholder="AAPL" required style="text-transform: uppercase;" list="symbol_datalist">
                <datalist id="symbol_datalist"></datalist>
                <select id="symbol_select" style="display:none;" required>
                    <option value="">-- Select Symbol --</option>
                </select>
            </div>
        </div>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="currency">Currency</label>
            <select id="currency" name="currency" required>
                {% for c in currencies %}
                <option value="{{ c }}" {% if c == 'CNY' %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="account_id">Account</label>
            <select id="account_id" name="account_id" required>
                <option value="">-- Select Account --</option>
                {% for a in accounts %}
                <option value="{{ a.account_id }}">{{ a.account_name }} ({{ a.account_id }})</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="quantity">Quantity</label>
            <input type="number" id="quantity" name="quantity" step="0.0001" min="0" required>
        </div>
        <div class="form-group">
            <label for="price">Price</label>
            <input type="number" id="price" name="price" step="0.01" min="0" required>
        </div>
        <div class="form-group">
            <label for="commission">Commission</label>
            <input type="number" id="commission" name="commission" step="0.01" value="0">
        </div>
    </div>

    <div class="form-group">
        <label for="notes">Notes (optional)</label>
        <textarea id="notes" name="notes" rows="2"></textarea>
    </div>

    <div class="form-group" id="link-cash-group">
        <label class="checkbox-label">
            <input type="checkbox" name="link_cash" id="link_cash" value="true">
            Link to Cash Account (Add/Deduct balance)
        </label>
    </div>

    <div class="form-group">
        <label>Total Amount</label>
        <div id="total-preview" class="total-preview text-right">0.00</div>
    </div>

    <button type="submit" class="btn btn-primary">Add Transaction</button>
</form>

<div id="holdings-data" style="display:none;">
    {% for h in holdings %}
    <span data-symbol="{{ h.symbol }}" data-asset-type="{{ h.asset_type }}" data-currency="{{ h.currency }}"></span>
    {% endfor %}
</div>

<script>
const qty = document.getElementById('quantity');
const price = document.getElementById('price');
const currency = document.getElementById('currency');
const preview = document.getElementById('total-preview');
const typeSelect = document.getElementById('transaction_type');
const symbolInput = document.getElementById('symbol');
const symbolSelect = document.getElementById('symbol_select');
const symbolDatalist = document.getElementById('symbol_datalist');
const assetTypeSelect = document.getElementById('asset_type');
const linkCashGroup = document.getElementById('link-cash-group');

const holdings = Array.from(document.querySelectorAll('#holdings-data span')).map(el => ({
    symbol: el.dataset.symbol,
    asset_type: el.dataset.assetType,
    currency: el.dataset.currency
}));

// Deduplicate holdings by symbol, asset_type, and currency
const uniqueHoldings = [];
const seen = new Set();
holdings.forEach(h => {
    const key = h.symbol + '|' + h.asset_type + '|' + h.currency;
    if (!seen.has(key)) {
        seen.add(key);
        uniqueHoldings.push(h);
    }
});

const symbols = { 'CNY': 'Â¥', 'USD': '$', 'HKD': 'HK$' };

function updateTotal() {
    const total = (parseFloat(qty.value) || 0) * (parseFloat(price.value) || 0);
    const sym = symbols[currency.value] || '';
    preview.textContent = sym + new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(total);
}

function updateSymbolOptions() {
    const selectedAssetType = assetTypeSelect.value;
    const selectedCurrency = currency.value;
    const currentSelectValue = symbolSelect.value;
    
    // Clear existing options
    symbolSelect.innerHTML = '<option value="">-- Select Symbol --</option>';
    symbolDatalist.innerHTML = '';
    
    // Filter holdings by asset type and currency
    const filteredSymbols = Array.from(new Set(
        uniqueHoldings
            .filter(h => h.asset_type === selectedAssetType && h.currency === selectedCurrency)
            .map(h => h.symbol)
    )).sort();

    filteredSymbols.forEach(sym => {
        // Populate Select
        const optSelect = document.createElement('option');
        optSelect.value = sym;
        optSelect.textContent = sym;
        if (sym === currentSelectValue) optSelect.selected = true;
        symbolSelect.appendChild(optSelect);
        
        // Populate Datalist
        const optData = document.createElement('option');
        optData.value = sym;
        symbolDatalist.appendChild(optData);
    });
}

function handleTypeChange() {
    const type = typeSelect.value;
    const restrictedTypes = ['SELL', 'DIVIDEND', 'SPLIT', 'TRANSFER_OUT', 'ADJUST'];
    const comboTypes = ['BUY', 'TRANSFER_IN'];
    
    updateSymbolOptions();

    if (type === 'INCOME') {
        symbolInput.style.display = 'block';
        symbolInput.name = 'symbol';
        symbolInput.value = 'CASH';
        symbolInput.readOnly = true;
        symbolInput.removeAttribute('list');
        
        symbolSelect.style.display = 'none';
        symbolSelect.name = '';
        symbolSelect.required = false;
        
        assetTypeSelect.value = 'cash';
        price.value = '1.0';
        price.readOnly = true;
        linkCashGroup.style.display = 'none';
    } else if (restrictedTypes.includes(type)) {
        symbolInput.style.display = 'none';
        symbolInput.name = '';
        symbolInput.required = false;
        
        symbolSelect.style.display = 'block';
        symbolSelect.name = 'symbol';
        symbolSelect.required = true;
        
        price.readOnly = false;
        linkCashGroup.style.display = (type === 'SELL') ? 'block' : 'none';
    } else if (comboTypes.includes(type)) {
        symbolInput.style.display = 'block';
        symbolInput.name = 'symbol';
        symbolInput.required = true;
        symbolInput.setAttribute('list', 'symbol_datalist');
        if (symbolInput.value === 'CASH') symbolInput.value = '';
        symbolInput.readOnly = false;
        
        symbolSelect.style.display = 'none';
        symbolSelect.name = '';
        symbolSelect.required = false;
        
        price.readOnly = false;
        linkCashGroup.style.display = (type === 'BUY') ? 'block' : 'none';
    } else {
        // Fallback for any other types
        symbolInput.style.display = 'block';
        symbolInput.name = 'symbol';
        symbolInput.required = true;
        symbolInput.removeAttribute('list');
        symbolInput.readOnly = false;
        
        symbolSelect.style.display = 'none';
        symbolSelect.name = '';
        symbolSelect.required = false;
        
        price.readOnly = false;
        linkCashGroup.style.display = 'none';
    }
    updateTotal();
}

qty.addEventListener('input', updateTotal);
price.addEventListener('input', updateTotal);
currency.addEventListener('change', () => {
    updateSymbolOptions();
    updateTotal();
});
typeSelect.addEventListener('change', handleTypeChange);
assetTypeSelect.addEventListener('change', () => {
    updateSymbolOptions();
});

// Initialize on load
handleTypeChange();
</script>
{% endblock %}
