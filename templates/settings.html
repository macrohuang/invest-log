{% extends "base.html" %}

{% block title %}Settings - Invest Log{% endblock %}

{% block content %}
<h1>Settings</h1>

{% if message %}
<div class="alert alert-{{ message_type }}" id="alertMessage">
    <span>{{ message }}</span>
    <button class="alert-close" onclick="this.parentElement.style.display='none'">&times;</button>
</div>
{% endif %}

<div class="settings-tabs">
    <button class="tab-link {% if active_tab == 'allocation' %}active{% endif %}" onclick="openTab(event, 'allocation')">Allocation</button>
    <button class="tab-link {% if active_tab == 'accounts' %}active{% endif %}" onclick="openTab(event, 'accounts')">Accounts</button>
    <button class="tab-link {% if active_tab == 'symbols' %}active{% endif %}" onclick="openTab(event, 'symbols')">Symbols</button>
    <button class="tab-link {% if active_tab == 'asset_types' %}active{% endif %}" onclick="openTab(event, 'asset_types')">Asset Types</button>
    <button class="tab-link {% if active_tab == 'database' %}active{% endif %}" onclick="openTab(event, 'database')">Database</button>
</div>

<!-- Allocation Settings Section -->
<div id="allocation" class="tab-content {% if active_tab == 'allocation' %}active{% endif %}">
    <div class="settings-panel">
        <h2>Allocation Settings</h2>
        <p class="subtitle">Set target allocation ranges for each currency and asset type. Warnings will be shown when allocations fall outside these ranges.</p>

        <form method="POST" action="/settings" class="settings-form">
            {% for currency in currencies %}
            <div class="settings-section">
                <h3>{{ currency }}</h3>
                <table class="settings-table">
                    <thead>
                        <tr>
                            <th>Asset Type</th>
                            <th>Min %</th>
                            <th>Max %</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for at in asset_types %}
                        <tr>
                            <td>{{ at.label }} <code>({{ at.code }})</code></td>
                            <td>
                                <input type="number" 
                                       name="{{ currency }}_{{ at.code }}_min" 
                                       value="{{ settings_map.get(currency, {}).get(at.code, {}).get('min', '') }}"
                                       min="0" max="100" step="0.1"
                                       placeholder="0">
                            </td>
                            <td>
                                <input type="number" 
                                       name="{{ currency }}_{{ at.code }}_max" 
                                       value="{{ settings_map.get(currency, {}).get(at.code, {}).get('max', '') }}"
                                       min="0" max="100" step="0.1"
                                       placeholder="100">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}

            <button type="submit" class="btn btn-primary">Save Allocation Settings</button>
        </form>
    </div>
</div>

<!-- Account Management Section -->
<div id="accounts" class="tab-content {% if active_tab == 'accounts' %}active{% endif %}">
    <div class="settings-panel">
        <h2>Account Management</h2>
        <p class="subtitle">Manage brokerage and bank accounts.</p>
        
        <table class="settings-table">
            <thead>
                <tr>
                    <th>Account ID</th>
                    <th>Name</th>
                    <th>Broker</th>
                    <th>Type</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for acc in accounts %}
                <tr>
                    <td><code>{{ acc.account_id }}</code></td>
                    <td>{{ acc.account_name }}</td>
                    <td>{{ acc.broker or '-' }}</td>
                    <td>{{ acc.account_type or '-' }}</td>
                    <td>
                        {% if acc.can_delete %}
                        <form method="POST" action="/settings/delete-account/{{ acc.account_id }}" style="display:inline;">
                            <button type="submit" class="btn-delete" onclick="return confirm('Delete account {{ acc.account_name }}?')">Delete</button>
                        </form>
                        {% else %}
                        <span class="text-muted">In use</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div class="add-form-container">
            <h3>Add New Account</h3>
            <form method="POST" action="/settings/add-account" class="form-grid">
                <div class="form-group">
                    <label>Account ID</label>
                    <input type="text" name="account_id" placeholder="e.g. broker-001" required>
                </div>
                <div class="form-group">
                    <label>Account Name</label>
                    <input type="text" name="account_name" placeholder="e.g. Interactive Brokers" required>
                </div>
                <div class="form-group">
                    <label>Broker</label>
                    <input type="text" name="broker" placeholder="e.g. IBKR">
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <input type="text" name="account_type" placeholder="e.g. Margin">
                </div>
                <div class="form-group">
                    <label>Initial Balance - CNY (¥)</label>
                    <input type="number" name="initial_balance_cny" placeholder="0.00" step="0.01" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Initial Balance - USD ($)</label>
                    <input type="number" name="initial_balance_usd" placeholder="0.00" step="0.01" min="0" value="0">
                </div>
                <div class="form-group">
                    <label>Initial Balance - HKD (HK$)</label>
                    <input type="number" name="initial_balance_hkd" placeholder="0.00" step="0.01" min="0" value="0">
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <small class="help-text">Optional: Set initial cash balances for this account. Non-zero values will create TRANSFER_IN transactions.</small>
                </div>
                <button type="submit" class="btn btn-primary">Add Account</button>
            </form>
        </div>
    </div>
</div>

<!-- Symbols Management Section -->
<div id="symbols" class="tab-content {% if active_tab == 'symbols' %}active{% endif %}">
    <div class="settings-panel">
        <h2>Symbol Management</h2>
        <p class="subtitle">Update symbol name, asset type, and auto update status. Changes apply globally.</p>

        {% if symbols %}
        <table class="settings-table">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Name</th>
                    <th>Asset Type</th>
                    <th class="text-center">Auto Update</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for sym in symbols %}
                <tr>
                    <td><code>{{ sym.symbol }}</code></td>
                    <td>
                        <input type="text" name="name" value="{{ sym.name or '' }}" form="symbol-form-{{ sym.id }}">
                    </td>
                    <td>
                        <select name="asset_type" form="symbol-form-{{ sym.id }}">
                            {% for at in asset_types %}
                            <option value="{{ at.code }}" {% if at.code == sym.asset_type %}selected{% endif %}>{{ at.label }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="text-center">
                        <input type="checkbox" name="auto_update" value="1" {% if sym.auto_update %}checked{% endif %} form="symbol-form-{{ sym.id }}">
                    </td>
                    <td>
                        <form id="symbol-form-{{ sym.id }}" method="POST" action="/settings/update-symbol" style="display:inline;">
                            <input type="hidden" name="symbol" value="{{ sym.symbol }}">
                            <button type="submit" class="btn btn-primary">Save</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">
            <p>No symbols found. Add a transaction to create one.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Asset Type Management Section -->
<div id="asset_types" class="tab-content {% if active_tab == 'asset_types' %}active{% endif %}">
    <div class="settings-panel">
        <h2>Asset Type Management</h2>
        <p class="subtitle">Manage asset types. Asset types can be used with any currency.</p>
        
        <table class="settings-table">
            <thead>
                <tr>
                    <th>Code</th>
                    <th>Label</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for at in asset_types %}
                <tr>
                    <td><code>{{ at.code }}</code></td>
                    <td>{{ at.label }}</td>
                    <td>
                        {% if at.can_delete %}
                        <form method="POST" action="/settings/delete-asset-type/{{ at.code }}" style="display:inline;">
                            <button type="submit" class="btn-delete" onclick="return confirm('Delete asset type {{ at.label }}?')">Delete</button>
                        </form>
                        {% else %}
                        <span class="text-muted" title="{{ at.delete_message }}">In use</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div class="add-form-container">
            <h3>Add New Asset Type</h3>
            <form method="POST" action="/settings/add-asset-type" class="form-inline">
                <div class="form-group">
                    <label>Code</label>
                    <input type="text" name="code" placeholder="e.g. fund" required pattern="[a-zA-Z_]+" title="Letters and underscores only">
                </div>
                <div class="form-group">
                    <label>Label</label>
                    <input type="text" name="label" placeholder="e.g. 基金" required>
                </div>
                <button type="submit" class="btn btn-primary">Add Asset Type</button>
            </form>
        </div>
    </div>
</div>

<!-- Database Settings Section -->
<div id="database" class="tab-content {% if active_tab == 'database' %}active{% endif %}">
    <div class="settings-panel">
        <h2>Database & Sync Settings</h2>
        <p class="subtitle">Configure where your transaction database is stored and manage iCloud synchronization.</p>
        
        <div class="current-info card">
            <p><strong>Current Database Path:</strong></p>
            <p><code class="break-word">{{ current_db_path }}</code></p>
        </div>

        <div class="add-form-container">
            <form method="POST" action="/settings/database" class="settings-form">
                <div class="form-group">
                    <label>Database Filename</label>
                    <input type="text" name="db_name" value="{{ user_config.db_name }}" placeholder="e.g. transactions.db" required>
                    <small class="help-text">The name of the SQLite database file. Default is <code>transactions.db</code>.</small>
                </div>
                
                <div class="form-group" style="margin-top: 1rem;">
                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" name="use_icloud" value="true" {% if user_config.use_icloud %}checked{% endif %} style="width: auto; margin: 0;">
                        Sync via iCloud Drive
                    </label>
                    <small class="help-text">When enabled, the database will be stored in your iCloud Drive folder for automatic backup and multi-device sync.</small>
                </div>
                
                <div class="form-actions" style="margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary">Save Database Settings</button>
                </div>
            </form>
            
            <div class="alert alert-info" style="margin-top: 1.5rem;">
                <p><strong>Note:</strong> Changing these settings will update <code>config.json</code>. The application may need a restart for the new path to take full effect. If the file doesn't exist at the new location, a new empty database will be initialized.</p>
            </div>
        </div>
    </div>
</div>

<style>
.break-word {
    word-break: break-all;
    display: block;
    padding: 0.75rem;
    background: var(--bg-secondary);
    border-radius: 4px;
    margin-top: 0.5rem;
}
.help-text {
    display: block;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}
.card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.25rem;
    margin-bottom: 2rem;
}
</style>

<script>
function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
    }
    tablinks = document.getElementsByClassName("tab-link");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].classList.remove("active");
    }
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
    
    // Update URL without refresh
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    window.history.pushState({}, '', url);
}
</script>
{% endblock %}
